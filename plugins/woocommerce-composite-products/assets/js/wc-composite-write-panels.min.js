jQuery(function(e){function t(e){var t=this;this.$el=e,this.$content=e.find(".bto_group_data"),this.$metabox_title=e.find("h3 .group_name"),this.$section_links=this.$content.find(".subsubsub a"),this.$sections=this.$content.find(".tab_group"),this.$discount=this.$content.find(".group_discount"),this.$filters=this.$content.find(".group_filters"),this.$display_prices=this.$content.find(".component_display_prices"),this.$pagination_style=this.$content.find(".component_pagination_style"),this.$query_type_containers=this.$content.find(".bto_query_type_selector"),this.$query_type_selector=this.$content.find("select.bto_query_type"),this.$options_style_selector=this.$content.find("select.options_style_selector"),this.$title_input=this.$content.find("input.group_title"),this.$priced_individually_input=this.$content.find(".group_priced_individually input"),this.$show_filters_input=this.$content.find(".group_show_filters input"),this.selectWoo_initialized=!1,this.component_toggled=function(){t.selectWoo_initialized||t.selectWoo_lazy()},this.section_changed=function(e){t.$section_links.removeClass("current"),e.addClass("current"),t.$sections.addClass("tab_group_hidden"),t.$content.find(".tab_group_"+e.data("tab")).removeClass("tab_group_hidden")},this.title_changed=function(){t.$metabox_title.text(t.$title_input.val())},this.query_type_changed=function(){t.$query_type_containers.hide(),t.$content.find(".bto_query_type_"+t.$query_type_selector.val()).show()},this.options_style_changed=function(){"yes"===t.$options_style_selector.find('option[value="'+t.$options_style_selector.val()+'"]').data("supports_pagination")?t.$pagination_style.show():t.$pagination_style.hide()},this.priced_individually_input_changed=function(){t.$priced_individually_input.is(":checked")?(t.$discount.show(),t.$display_prices.show()):(t.$discount.hide(),t.$display_prices.hide())},this.show_filters_input_changed=function(){t.$show_filters_input.is(":checked")?t.$filters.show():t.$filters.hide()},this.initialize=function(){t.query_type_changed(),t.options_style_changed(),t.priced_individually_input_changed(),t.show_filters_input_changed()},this.selectWoo_lazy=function(){var e=t.$content.find(".wc-product-search-lazy"),o=t.$content.find(".wc-enhanced-select-lazy");e.addClass("wc-product-search"),o.addClass("wc-enhanced-select"),t.$content.wc_cp_select2(),e.removeClass("wc-product-search"),o.removeClass("wc-enhanced-select"),t.selectWoo_initialized=!0},this.initialize()}function o(){f.length>0?u.removeClass("disabled"):u.addClass("disabled")}function n(){m.on("click",".expand_all",function(){return!e(this).hasClass("disabled")&&(e.each(b,function(e,t){t.selectWoo_lazy(),setTimeout(function(){t.$content.show()},50)}),!1)}).on("mouseover click",".bto_group_handle",function(){var t=e(this).closest(".bto_group").data("component_metabox_id"),o=b[t];void 0!==o&&o.component_toggled()}).on("click",".subsubsub a",function(t){var o=e(this),n=e(this).closest(".bto_group").data("component_metabox_id");b[n].section_changed(o),t.preventDefault()}).on("click","a.remove_row",function(t){var o=e(this).closest(".bto_group"),n=o.data("component_metabox_id");o.find("*").off(),o.remove(),delete b[n],p.triggerHandler("wc-cp-components-changed"),t.preventDefault()}).on("keyup","input.group_title",function(){var t=e(this).closest(".bto_group").data("component_metabox_id");b[t].title_changed()}).on("change","select.bto_query_type",function(){var t=e(this).closest(".bto_group").data("component_metabox_id");b[t].query_type_changed()}).on("change","select.options_style_selector",function(){var t=e(this).closest(".bto_group").data("component_metabox_id");b[t].options_style_changed()}).on("change",".group_priced_individually input",function(){var t=e(this).closest(".bto_group").data("component_metabox_id");b[t].priced_individually_input_changed()}).on("change",".group_show_filters input",function(){var t=e(this).closest(".bto_group").data("component_metabox_id");b[t].show_filters_input_changed()}).on("click",".upload_component_image_button",function(t){z.$button=e(this),t.preventDefault(),z.image_frame?z.image_frame.open():(z.image_frame=wp.media({title:wc_composite_admin_params.i18n_choose_component_image,button:{text:wc_composite_admin_params.i18n_set_component_image},states:[new wp.media.controller.Library({title:wc_composite_admin_params.i18n_choose_component_image,filterable:"all"})]}),z.image_frame.on("select",function(){var e=z.image_frame.state().get("selection").first().toJSON(),t=e.sizes&&e.sizes.thumbnail?e.sizes.thumbnail.url:e.url;z.$button.addClass("has_image"),z.$button.closest(".component_image").find(".remove_component_image_button").addClass("has_image"),z.$button.find("input").val(e.id).change(),z.$button.find("img").eq(0).attr("src",t)}),z.image_frame.open())}).on("click",".remove_component_image_button",function(t){var o=e(this),n=o.closest(".component_image"),i=n.find(".upload_component_image_button");t.preventDefault(),i.removeClass("has_image"),o.removeClass("has_image"),n.find("input").val("").change(),i.find("img").eq(0).attr("src",wc_composite_admin_params.wc_placeholder_img_src)}),p.on("click","button.add_bto_group",function(){p.block(W),g++;var o={action:"woocommerce_add_composite_component",post_id:woocommerce_admin_meta_boxes.post_id,id:g,security:wc_composite_admin_params.add_component_nonce};return setTimeout(function(){e.post(woocommerce_admin_meta_boxes.ajax_url,o,function(o){h.append(o);var n=e(".bto_group",h).last(),i=new t(n),a="component_"+g;n.data("component_metabox_id",a),b[a]=i,p.triggerHandler("wc-cp-components-changed"),i.selectWoo_lazy(),n.find(".woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200}),p.triggerHandler("wc-cp-component-added",[i]),p.unblock()})},250),!1})}function i(){h.sortable({items:".bto_group",cursor:"move",axis:"y",handle:"h3",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,placeholder:"wc-metabox-sortable-placeholder",start:function(e,t){t.item.css("background-color","#f6f6f6")},stop:function(e,t){t.item.removeAttr("style"),p.triggerHandler("wc-cp-components-changed")}}),o()}function a(){b={},f.each(function(o){var n=e(this),i="component_"+o;n.data("component_metabox_id",i),b[i]=new t(n)}),i()}function c(e){var t=this;this.$el=e,this.$content=e.find(".bto_scenario_data"),this.$metabox_title=e.find("h3 .scenario_name"),this.$title_input=this.$content.find("input.scenario_title"),this.$conditional_components_action_input=this.$content.find(".toggle_conditional_components input"),this.$conditional_components_action_config=this.$content.find(".scenario_action_conditional_components_group .action_components"),this.selectWoo_initialized=!1,this.scenario_toggled=function(){t.selectWoo_initialized||t.selectWoo_lazy()},this.title_changed=function(){t.$metabox_title.text(t.$title_input.val())},this.component_modifier_changed=function(e){"masked"===e.val()?e.closest(".bto_scenario_selector").find(".bto_scenario_selector_inner").slideUp(200):e.closest(".bto_scenario_selector").find(".bto_scenario_selector_inner").slideDown(200)},this.conditional_components_action_input_changed=function(){t.$conditional_components_action_input.is(":checked")?t.$conditional_components_action_config.slideDown(200):t.$conditional_components_action_config.slideUp(200)},this.selectWoo_lazy=function(){var e=t.$content.find(".wc-component-options-search-lazy"),o=t.$content.find(".wc-enhanced-select-lazy");e.addClass("wc-component-options-search"),o.addClass("wc-enhanced-select"),t.$content.wc_cp_select2(),t.$content.wc_cp_select2_component_options(),e.removeClass("wc-component-options-search"),o.removeClass("wc-enhanced-select"),t.selectWoo_initialized=!0},this.initialize=function(){},this.initialize()}function s(){x.length>0?v.removeClass("disabled"):v.addClass("disabled")}function _(){y.on("click",".expand_all",function(){return!e(this).hasClass("disabled")&&(e.each(k,function(e,t){t.selectWoo_lazy(),setTimeout(function(){t.$content.show()},50)}),!1)}).on("mouseover click",".bto_scenario_handle",function(){var t=e(this).closest(".bto_scenario").data("scenario_metabox_id"),o=k[t];void 0!==o&&o.scenario_toggled()}).on("click","a.remove_row",function(t){var o=e(this).closest(".bto_scenario"),n=o.data("scenario_metabox_id");o.find("*").off(),o.remove(),delete k[n],w.triggerHandler("wc-cp-scenarios-changed"),t.preventDefault()}).on("keyup","input.scenario_title",function(){var t=e(this).closest(".bto_scenario").data("scenario_metabox_id");k[t].title_changed()}).on("change","select.bto_scenario_exclude",function(){var t=e(this).closest(".bto_scenario").data("scenario_metabox_id");k[t].component_modifier_changed(e(this))}).on("change",".toggle_conditional_components input",function(){var t=e(this).closest(".bto_scenario").data("scenario_metabox_id");k[t].conditional_components_action_input_changed()}).on("click","button.add_bto_scenario",function(){w.block(W),C++;var t={action:"woocommerce_add_composite_scenario",post_id:woocommerce_admin_meta_boxes.post_id,id:C,security:wc_composite_admin_params.add_scenario_nonce};return setTimeout(function(){e.post(woocommerce_admin_meta_boxes.ajax_url,t,function(t){$.append(t);var o=e(".bto_scenario",$).last(),n=new c(o),i="scenario_"+C;o.data("scenario_metabox_id",i),k[i]=n,w.triggerHandler("wc-cp-scenarios-changed"),n.selectWoo_lazy(),o.find(".tips, .woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200}),w.triggerHandler("wc-cp-scenario-added",[n]),w.unblock()})},250),!1})}function r(){$.sortable({items:".bto_scenario",cursor:"move",axis:"y",handle:"h3",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,placeholder:"wc-metabox-sortable-placeholder",start:function(e,t){t.item.css("background-color","#f6f6f6")},stop:function(e,t){t.item.removeAttr("style"),w.triggerHandler("wc-cp-scenarios-changed")}}),s()}function l(){k={},x.each(function(t){var o=e(this),n="scenario_"+t;o.data("scenario_metabox_id",n),k[n]=new c(o)}),r()}var d={language:{errorLoading:function(){return wc_composite_admin_params.i18n_searching},inputTooLong:function(e){var t=e.input.length-e.maximum;return 1===t?wc_composite_admin_params.i18n_input_too_long_1:wc_composite_admin_params.i18n_input_too_long_n.replace("%qty%",t)},inputTooShort:function(e){var t=e.minimum-e.input.length;return 1===t?wc_composite_admin_params.i18n_input_too_short_1:wc_composite_admin_params.i18n_input_too_short_n.replace("%qty%",t)},loadingMore:function(){return wc_composite_admin_params.i18n_load_more},maximumSelected:function(e){return 1===e.maximum?wc_composite_admin_params.i18n_selection_too_long_1:wc_composite_admin_params.i18n_selection_too_long_n.replace("%qty%",e.maximum)},noResults:function(){return wc_composite_admin_params.i18n_no_matches},searching:function(){return wc_composite_admin_params.i18n_searching}}};e.fn.wc_cp_select2=function(){e(":input.wc-enhanced-select",this).filter(":not(.enhanced)").each(function(){var t=e(this),o=e.extend({minimumResultsForSearch:10,allowClear:!!t.data("allow_clear"),placeholder:t.data("placeholder")},d);if("yes"===wc_composite_admin_params.is_wc_version_gte_3_2?t.selectWoo(o).addClass("enhanced"):t.select2(o).addClass("enhanced"),t.data("sortable")){var n=t.next(".select2-container").find("ul.select2-selection__rendered");n.sortable({placeholder:"ui-state-highlight select2-selection__choice",forcePlaceholderSize:!0,items:"li:not(.select2-search__field)",tolerance:"pointer",stop:function(){e(n.find(".select2-selection__choice").get().reverse()).each(function(){var o=e(this).data("data").id,n=t.find('option[value="'+o+'"]')[0];t.prepend(n)})}})}}),e(":input.wc-product-search",this).filter(":not(.enhanced)").each(function(){var t=e(this),o={allowClear:!!t.data("allow_clear"),placeholder:t.data("placeholder"),minimumInputLength:t.data("minimum_input_length")?t.data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:{url:wc_enhanced_select_params.ajax_url,dataType:"json",delay:250,data:function(e){return{term:e.term,action:t.data("action")||"woocommerce_json_search_products_and_variations",security:wc_enhanced_select_params.search_products_nonce,exclude:t.data("exclude"),include:t.data("include"),limit:t.data("limit")}},processResults:function(t){var o=[];return t&&e.each(t,function(e,t){o.push({id:e,text:t})}),{results:o}},cache:!0}};if(o=e.extend(o,d),"yes"===wc_composite_admin_params.is_wc_version_gte_3_2?t.selectWoo(o).addClass("enhanced"):t.select2(o).addClass("enhanced"),t.data("sortable")){var n=e(this).next(".select2-container").find("ul.select2-selection__rendered");n.sortable({placeholder:"ui-state-highlight select2-selection__choice",forcePlaceholderSize:!0,items:"li:not(.select2-search__field)",tolerance:"pointer",stop:function(){e(n.find(".select2-selection__choice").get().reverse()).each(function(){var o=e(this).data("data").id,n=t.find('option[value="'+o+'"]')[0];t.prepend(n)})}})}else t.prop("multiple")&&t.on("change",function(){var e=t.children();e.sort(function(e,t){var o=e.text.toLowerCase(),n=t.text.toLowerCase();return o>n?1:o<n?-1:0}),t.html(e)})})},e.fn.wc_cp_select2_component_options=function(){e(":input.wc-component-options-search",this).filter(":not(.enhanced)").each(function(){var t=e(this),o=t.data("action"),n={allowClear:!!t.data("allow_clear"),placeholder:t.data("placeholder"),minimumInputLength:t.data("minimum_input_length")?e(this).data("minimum_input_length"):"3",escapeMarkup:function(e){return e},ajax:{url:wc_enhanced_select_params.ajax_url,dataType:"json",quietMillis:250,data:function(e){return{term:e.term,action:o,security:wc_enhanced_select_params.search_products_nonce,exclude:t.data("exclude"),include:t.data("include"),limit:t.data("limit")}},processResults:function(o){var n=[];return"yes"===t.data("component_optional")&&n.push({id:"-1",text:wc_composite_admin_params.i18n_none}),n.push({id:"0",text:wc_composite_admin_params.i18n_all}),o&&e.each(o,function(e,t){n.push({id:e,text:t})}),{results:n}},cache:!0}};n=e.extend(n,d),"yes"===wc_composite_admin_params.is_wc_version_gte_3_2?e(this).selectWoo(n).addClass("enhanced"):e(this).select2(n).addClass("enhanced")})};var p=e("#bto_product_data"),u=p.find(".bulk_toggle_wrapper"),m=e(".config_group",p),h=e(".bto_groups",m),f=e(".bto_group",h),g=f.length,b={},w=e("#bto_scenario_data"),v=w.find(".bulk_toggle_wrapper"),y=e(".scenarios_config_group",w),$=e(".bto_scenarios",w),x=e(".bto_scenario",$),C=x.length,k={},z={image_frame:!1,$button:!1},W={message:null,overlayCSS:{background:"#fff",opacity:.6}};e(".composite_stock_msg").appendTo("._manage_stock_field .description"),e("#_sold_individually").closest(".form-field").addClass("hide_if_composite"),e("#linked_product_data .grouping.show_if_simple, #linked_product_data .form-field.show_if_grouped").addClass("hide_if_composite"),e(".show_if_simple:not(.hide_if_composite)").addClass("show_if_composite"),"undefined"==typeof woocommerce_admin_meta_boxes&&(woocommerce_admin_meta_boxes=woocommerce_writepanel_params),e("body").on("woocommerce-product-type-change",function(t,o){"composite"===o&&(e(".show_if_external").hide(),e(".show_if_composite").show(),e("input#_manage_stock").change())}),e("select#product-type").change(),e("input#_downloadable").change(function(){e("select#product-type").change()}),e(".bundle_group .bto_layouts",p).on("click",".bto_layout_label",function(){e(this).closest(".bto_layouts").find(".selected").removeClass("selected"),e(this).addClass("selected")}),p.on("wc-cp-components-changed",function(){h=e(".bto_groups",m),(f=e(".bto_group",h)).each(function(t,o){e(".group_position",o).val(t),e(o).attr("rel",t)}),o()}),w.on("wc-cp-scenarios-changed",function(){$=e(".bto_scenarios",w),(x=e(".bto_scenario",$)).each(function(t,o){e(".scenario_position",o).val(t),e(o).attr("rel",t)}),s()}),n(),a(),_(),l(),e(".save_composition").on("click",function(){p.block(W),w.block(W),f.find("*").off();var t={post_id:woocommerce_admin_meta_boxes.post_id,data:e("#bto_product_data, #bto_scenario_data").find("input, select, textarea").serialize(),action:"woocommerce_bto_composite_save",security:wc_composite_admin_params.save_composite_nonce};setTimeout(function(){e.post(woocommerce_admin_meta_boxes.ajax_url,t,function(t){var o=window.location.toString();o=o.replace("post-new.php?","post.php?post="+woocommerce_admin_meta_boxes.post_id+"&action=edit&"),e.get(o,function(o){var n=[],i=[],c=e("#bto_config_group_inner",p),s=e("#bto_scenarios_inner",w),_=e(o).find("#bto_config_group_inner"),r=_.find(".bto_group"),d=e(o).find("#bto_scenarios_inner"),m=d.find(".bto_scenario");f.length===r.length&&f.each(function(){var t=e(this);if(t.hasClass("open")){var o=t.attr("rel");n.push(o)}}),r.each(function(){var t=e(this),o=t.attr("rel");-1!==e.inArray(o,n)?(t.addClass("open").removeClass("closed"),t.find(".wc-metabox-content").show()):t.find(".wc-metabox-content").hide()}),x.length===m.length&&s.find(".bto_scenario").each(function(){var t=e(this);if(t.hasClass("open")){var o=t.attr("rel");i.push(o)}}),m.each(function(){var t=e(this),o=t.attr("rel");-1!==e.inArray(o,i)?(t.addClass("open").removeClass("closed"),t.find(".wc-metabox-content").show()):t.find(".wc-metabox-content").hide()}),f.find("*").off(),x.find("*").off(),c.html(_.html()),s.html(d.html()),u=c.find(".bulk_toggle_wrapper"),v=s.find(".bulk_toggle_wrapper"),p.triggerHandler("wc-cp-components-changed"),a(),w.triggerHandler("wc-cp-scenarios-changed"),l(),e("#bto_product_data .woocommerce-help-tip, #bto_scenario_data .woocommerce-help-tip, #bto_scenario_data .tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200}),f.each(function(){var t=e(this);if(t.hasClass("open")){var o=t.data("component_metabox_id");b[o].selectWoo_lazy()}}),x.each(function(){var t=e(this);if(t.hasClass("open")){var o=t.data("scenario_metabox_id");k[o].selectWoo_lazy()}}),t.length>0&&e.each(t,function(e,t){window.alert(t)}),p.unblock(),w.unblock()})},"json")},250)})});